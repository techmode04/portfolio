import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  onSnapshot, 
  addDoc, 
  deleteDoc, 
  doc,
  setLogLevel
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- Firebase Configuration ---
// These variables are expected to be globally available in your environment.
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // Fallback config

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-video-portfolio';

// --- Firebase Initialization ---
let app;
let db;
let auth;
try {
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
  setLogLevel('debug'); // Enable Firestore debug logging
} catch (e) {
  console.error("Error initializing Firebase: ", e);
}

// --- Helper Functions ---
/**
 * Extracts a YouTube video ID from various URL formats.
 * @param {string} url - The YouTube URL.
 * @returns {string|null} - The video ID or null if not found.
 */
const getYouTubeID = (url) => {
  if (!url) return null;
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
};

/**
 * Extracts a Vimeo video ID from various URL formats.
 * @param {string} url - The Vimeo URL.
 * @returns {string|null} - The video ID or null if not found.
 */
const getVimeoID = (url) => {
  if (!url) return null;
  const regExp = /https?:\/\/(?:www\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|album\/(\d+)\/video\/|)(\d+)(?:$|\/|\?)/;
  const match = url.match(regExp);
  return match ? match[3] : null;
};

// --- React Components ---

/**
 * Header/Navbar Component
 * @param {function} setPage - Function to change the current page view.
 * @param {string} currentPage - The currently active page.
 */
const Header = ({ setPage, currentPage }) => {
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  const navItems = [
    { name: 'Home', page: 'home' },
    { name: 'Reels', page: 'reels' },
    { name: 'Cooking', page: 'cooking' },
    { name: 'Long Videos', page: 'long' },
    { name: 'About', page: 'about' },
    { name: 'Contact', page: 'contact' },
    { name: 'Admin', page: 'admin' }, // Page to manage videos
  ];

  const NavLink = ({ page, name }) => (
    <button
      onClick={() => {
        setPage(page);
        setIsMobileMenuOpen(false);
      }}
      className={`px-3 py-2 rounded-md text-sm font-medium transition-colors duration-300 ${
        currentPage === page
          ? 'bg-emerald-500 text-white'
          : 'text-gray-300 hover:bg-gray-700 hover:text-white'
      }`}
    >
      {name}
    </button>
  );

  return (
    <nav className="bg-black bg-opacity-80 backdrop-blur-md shadow-lg fixed w-full z-50 top-0 border-b border-gray-700/50">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex-shrink-0 flex items-center">
            {/* Logo */}
            <span className="text-2xl font-bold text-white flex items-center">
              <span className="bg-emerald-500 p-2 rounded-lg mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </span>
              Creator<span className="text-emerald-400">Hub</span>
            </span>
          </div>
          {/* Desktop Menu */}
          <div className="hidden md:block">
            <div className="ml-10 flex items-baseline space-x-4">
              {navItems.map((item) => (
                <NavLink key={item.name} page={item.page} name={item.name} />
              ))}
            </div>
          </div>
          {/* Mobile Menu Button */}
          <div className="-mr-2 flex md:hidden">
            <button
              onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
              type="button"
              className="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white"
              aria-controls="mobile-menu"
              aria-expanded="false"
            >
              <span className="sr-only">Open main menu</span>
              {isMobileMenuOpen ? (
                // X icon
                <svg className="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              ) : (
                // Hamburger icon
                <svg className="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              )}
            </button>
          </div>
        </div>
      </div>
      {/* Mobile Menu */}
      <div className={`${isMobileMenuOpen ? 'block' : 'hidden'} md:hidden border-t border-gray-700`} id="mobile-menu">
        <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          {navItems.map((item) => (
            <button
              key={item.name}
              onClick={() => {
                setPage(item.page);
                setIsMobileMenuOpen(false);
              }}
              className={`w-full text-left block px-3 py-2 rounded-md text-base font-medium transition-colors duration-300 ${
                currentPage === item.page
                  ? 'bg-emerald-500 text-white'
                  : 'text-gray-300 hover:bg-gray-700 hover:text-white'
              }`}
            >
              {item.name}
            </button>
          ))}
        </div>
      </div>
    </nav>
  );
};

/**
 * Hero Section Component
 */
const HeroSection = () => (
  <section id="home" className="min-h-screen flex items-center justify-center text-center bg-gray-900 text-white pt-16">
    <div className="relative z-10 p-6 max-w-3xl mx-auto">
      <h1 className="text-5xl md:text-7xl font-extrabold mb-4 leading-tight">
        Telling Stories
        <br />
        Through <span className="text-emerald-400">Frames</span> ðŸŽ¬
      </h1>
      <p className="text-lg md:text-xl text-gray-300 mb-8">
        Cinematic video editing and storytelling that captivates and inspires.
      </p>
      <a
        href="#reels"
        onClick={(e) => {
          e.preventDefault();
          document.getElementById('gallery-start')?.scrollIntoView({ behavior: 'smooth' });
        }}
        className="inline-block bg-emerald-500 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-emerald-600 transition-all duration-300 transform hover:scale-105 shadow-lg shadow-emerald-500/30"
      >
        View My Work
      </a>
    </div>
    {/* Optional: background video or image */}
    <div className="absolute inset-0 bg-black opacity-50 z-0"></div>
    {/* You could add a subtle background video here */}
  </section>
);

/**
 * Video Card Component
 * @param {object} video - Video object { id, title, url, category }
 * @param {function} [onDelete] - Optional delete handler for admin panel
 */
const VideoCard = ({ video, onDelete }) => {
  const [showPlayer, setShowPlayer] = useState(false);
  const [embedUrl, setEmbedUrl] = useState(null);
  const [thumbnailUrl, setThumbnailUrl] = useState(null);

  useEffect(() => {
    const youtubeId = getYouTubeID(video.url);
    if (youtubeId) {
      setEmbedUrl(`https://www.youtube.com/embed/${youtubeId}?autoplay=1&rel=0`);
      setThumbnailUrl(`https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg`);
      return;
    }

    const vimeoId = getVimeoID(video.url);
    if (vimeoId) {
      setEmbedUrl(`https://player.vimeo.com/video/${vimeoId}?autoplay=1`);
      // Fetch Vimeo thumbnail (more complex, requires API or oEmbed)
      // For simplicity, we'll use a placeholder
      fetch(`https://vimeo.com/api/oembed.json?url=${encodeURIComponent(video.url)}&width=640`)
        .then(res => res.json())
        .then(data => {
          setThumbnailUrl(data.thumbnail_url);
        })
        .catch(() => {
          setThumbnailUrl('https://placehold.co/640x360/1a1a1a/333?text=Vimeo+Video');
        });
      return;
    }
    
    // Fallback for direct video links or other services
    setEmbedUrl(null); // Can't embed directly without knowing the player
    setThumbnailUrl('https://placehold.co/640x360/1a1a1a/333?text=Video+Preview');

  }, [video.url]);

  if (showPlayer && embedUrl) {
    return (
      <div className="aspect-video w-full bg-black rounded-lg overflow-hidden shadow-2xl shadow-emerald-500/20">
        <iframe
          src={embedUrl}
          frameBorder="0"
          allow="autoplay; fullscreen; picture-in-picture"
          allowFullScreen
          className="w-full h-full"
          title={video.title}
        ></iframe>
      </div>
    );
  }

  return (
    <div
      className="group relative aspect-video w-full rounded-lg overflow-hidden cursor-pointer shadow-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-emerald-500/30"
      onClick={() => embedUrl && setShowPlayer(true)}
    >
      {/* Thumbnail */}
      <img
        src={thumbnailUrl || 'https://placehold.co/640x360/1a1a1a/333?text=Loading...'}
        alt={video.title}
        className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
        onError={(e) => { e.target.src = 'https://placehold.co/640x360/1a1a1a/ff0000?text=Error+Loading'; }}
      />
      {/* Overlay */}
      <div className="absolute inset-0 bg-black bg-opacity-40 group-hover:bg-opacity-20 transition-all duration-300"></div>
      {/* Play Icon */}
      <div className="absolute inset-0 flex items-center justify-center">
        <div className="bg-white bg-opacity-20 backdrop-blur-sm p-4 rounded-full text-white transition-all duration-300 transform scale-75 opacity-0 group-hover:scale-100 group-hover:opacity-100">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12" viewBox="0 0 20 20" fill="currentColor">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.006v3.988a1 1 0 001.555.832l3.197-1.994a1 1 0 000-1.664l-3.197-1.994z" clipRule="evenodd" />
          </svg>
        </div>
      </div>
      {/* Title */}
      <div className="absolute bottom-0 left-0 p-4">
        <span className="inline-block bg-emerald-500 text-black text-xs font-semibold px-2 py-1 rounded-full uppercase mb-1">
          {video.category}
        </span>
        <h3 className="text-white text-lg font-bold truncate">{video.title}</h3>
      </div>
      {/* Delete Button (for Admin) */}
      {onDelete && (
        <button
          onClick={(e) => {
            e.stopPropagation(); // Prevent opening the player
            onDelete(video.id);
          }}
          className="absolute top-2 right-2 bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-all z-20"
          title="Delete Video"
        >
          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      )}
    </div>
  );
};

/**
 * Video Gallery Component
 * @param {array} videos - Array of all video objects.
 * @param {string} initialFilter - The default filter to apply ('all', 'reels', 'cooking', 'long').
 */
const VideoGallery = ({ videos, initialFilter = 'all' }) => {
  const [filter, setFilter] = useState(initialFilter);

  const filteredVideos = useMemo(() => {
    if (filter === 'all') {
      return videos;
    }
    return videos.filter(video => video.category.toLowerCase() === filter.toLowerCase());
  }, [videos, filter]);

  const filters = [
    { name: 'All', key: 'all' },
    { name: 'Reels', key: 'reels' },
    { name: 'Cooking', key: 'cooking' },
    { name: 'Long Videos', key: 'long' },
  ];

  return (
    <section id="gallery-start" className="py-20 md:py-28 bg-gray-900 text-white">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* Title */}
        <h2 className="text-3xl md:text-4xl font-extrabold text-center mb-12">
          My <span className="text-emerald-400">Work</span>
        </h2>
        
        {/* Filter Buttons */}
        <div className="flex justify-center flex-wrap gap-3 mb-12">
          {filters.map((f) => (
            <button
              key={f.key}
              onClick={() => setFilter(f.key)}
              className={`px-6 py-2 font-medium rounded-full transition-all duration-300 transform hover:scale-105 ${
                filter === f.key
                  ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30'
                  : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
              }`}
            >
              {f.name}
            </button>
          ))}
        </div>

        {/* Video Grid */}
        {videos.length === 0 ? (
          <p className="text-center text-gray-400">Loading videos... (If this persists, go to the 'Admin' page to add some!)</p>
        ) : filteredVideos.length === 0 ? (
          <p className="text-center text-gray-400">No videos found in this category.</p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {filteredVideos.map((video) => (
              <VideoCard key={video.id} video={video} />
            ))}
          </div>
        )}
      </div>
    </section>
  );
};

/**
 * About Section Component
 */
const AboutSection = () => (
  <section id="about" className="py-20 md:py-28 bg-black text-white">
    <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div className="flex flex-col md:flex-row items-center gap-12 md:gap-16">
        {/* Profile Photo */}
        <div className="flex-shrink-0 w-64 h-64 md:w-80 md:h-80 relative">
          <img
            src="https://placehold.co/400x400/1a1a1a/emerald?text=Creator"
            alt="Video Creator"
            className="w-full h-full rounded-full object-cover shadow-2xl"
          />
          {/* Accent Ring */}
          <div className="absolute inset-0 rounded-full border-4 border-emerald-500 animate-pulse-slow"></div>
          <div className="absolute -top-2 -left-2 w-full h-full rounded-full border-4 border-emerald-500 opacity-30"></div>
          <div className="absolute -bottom-2 -right-2 w-full h-full rounded-full border-4 border-emerald-500 opacity-30"></div>
        </div>
        
        {/* Bio Content */}
        <div className="flex-1 text-center md:text-left">
          <h2 className="text-3xl md:text-4xl font-extrabold mb-4">
            About <span className="text-emerald-400">Me</span>
          </h2>
          <p className="text-lg text-gray-300 mb-6 leading-relaxed">
            I'm a passionate freelance video editor specializing in cinematic storytelling, 
            short-form content, and creative color grading. My goal is to turn raw footage 
            into visual stories that leave a lasting impression. Whether it's for a brand, vlog, or business â€” 
            I craft edits that connect.
          </p>
          <p className="text-lg text-gray-300 mb-8 leading-relaxed">
            Let's create something amazing together.
          </p>
          {/* Social Links */}
          <div className="flex justify-center md:justify-start space-x-6">
            <SocialLink href="https://instagram.com" icon="fab fa-instagram" label="Instagram" />
            <SocialLink href="https://youtube.com" icon="fab fa-youtube" label="YouTube" />
            <SocialLink href="mailto:hello@creator.com" icon="fas fa-envelope" label="Email" />
          </div>
        </div>
      </div>
    </div>
  </section>
);

/**
 * Social Link Helper Component
 * @param {string} href - URL
 * @param {string} icon - FontAwesome icon class (e.g., 'fab fa-instagram')
 * @param {string} label - Aria-label for accessibility
 */
const SocialLink = ({ href, icon, label }) => (
  <a
    href={href}
    target="_blank"
    rel="noopener noreferrer"
    aria-label={label}
    className="text-gray-400 hover:text-emerald-400 transition-colors duration-300 transform hover:scale-110"
  >
    <i className={`${icon} fa-2x`}></i>
  </a>
);

/**
 * Contact Section Component
 */
const ContactSection = () => (
  <section id="contact" className="py-20 md:py-28 bg-gray-900 text-white">
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 className="text-3xl md:text-4xl font-extrabold mb-4">
        Let's Work <span className="text-emerald-400">Together</span>
      </h2>
      <p className="text-lg text-gray-300 mb-8 max-w-xl mx-auto">
        Have a project in mind? I'd love to hear about it.
        Send me an email, and I'll get back to you as soon as possible.
      </p>
      <a
        href="mailto:hello@creator.com"
        className="inline-block bg-emerald-500 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-emerald-600 transition-all duration-300 transform hover:scale-105 shadow-lg shadow-emerald-500/30"
      >
        <i className="fas fa-envelope mr-2"></i>
        Get In Touch
      </a>
    </div>
  </section>
);

/**
 * Admin Panel Component (for backend functionality)
 * @param {array} videos - Array of all video objects.
 * @param {function} onAddVideo - Function to add a new video.
 * @param {function} onDeleteVideo - Function to delete a video.
 * @param {string} error - Error message string.
 * @param {boolean} loading - Loading state.
 * @param {string} userId - Current User ID.
 */
const AdminPanel = ({ videos, onAddVideo, onDeleteVideo, error, loading, userId }) => {
  const [title, setTitle] = useState('');
  const [url, setUrl] = useState('');
  const [category, setCategory] = useState('reels');
  
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title || !url || !category) {
      alert('Please fill in all fields.');
      return;
    }
    onAddVideo({ title, url, category });
    setTitle('');
    setUrl('');
    setCategory('reels');
  };

  return (
    <section id="admin" className="pt-24 pb-20 min-h-screen bg-black text-white">
      <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 className="text-3xl md:text-4xl font-extrabold text-center mb-12">
          Admin <span className="text-emerald-400">Panel</span>
        </h2>
        
        <p className="text-center text-gray-400 mb-2">
          Your User ID: <code className="bg-gray-800 text-emerald-400 p-1 rounded-md">{userId || 'Loading...'}</code>
        </p>
        <p className="text-center text-gray-500 mb-12 text-sm">
          (This portfolio uses a public database for this demo. Anyone with this App ID can add/delete videos.)
        </p>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
          {/* Add Video Form */}
          <div className="bg-gray-900 p-6 md:p-8 rounded-lg shadow-2xl border border-gray-700/50">
            <h3 className="text-2xl font-bold mb-6 text-emerald-400">Add New Video</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="title" className="block text-sm font-medium text-gray-300 mb-1">Title</label>
                <input
                  type="text"
                  id="title"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  placeholder="My Awesome Reel"
                />
              </div>
              <div>
                <label htmlFor="url" className="block text-sm font-medium text-gray-300 mb-1">Video URL</label>
                <input
                  type="text"
                  id="url"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  placeholder="https://www.youtube.com/watch?v=..."
                />
              </div>
              <div>
                <label htmlFor="category" className="block text-sm font-medium text-gray-300 mb-1">Category</label>
                <select
                  id="category"
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"
                >
                  <option value="reels">Reels</option>
                  <option value="cooking">Cooking</option>
                  <option value="long">Long Videos</option>
                </select>
              </div>
              <button
                type="submit"
                disabled={loading}
                className="w-full bg-emerald-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-600 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {loading ? 'Adding...' : 'Add Video'}
              </button>
              {error && <p className="text-red-400 text-sm mt-2">{error}</p>}
            </form>
          </div>

          {/* Manage Videos List */}
          <div className="bg-gray-900 p-6 md:p-8 rounded-lg shadow-2xl border border-gray-700/50">
            <h3 className="text-2xl font-bold mb-6 text-emerald-400">Manage Videos</h3>
            <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
              {videos.length === 0 ? (
                <p className="text-gray-400">No videos found. Add one!</p>
              ) : (
                videos.map(video => (
                  <div key={video.id} className="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                    <div className="flex-1 min-w-0">
                      <p className="text-white font-medium truncate">{video.title}</p>
                      <p className="text-sm text-gray-400 truncate">{video.url}</p>
                    </div>
                    <button
                      onClick={() => onDeleteVideo(video.id)}
                      className="ml-4 flex-shrink-0 bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-all"
                      title="Delete Video"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      </div>
    </section>
  );
};

/**
 * Footer Component
 */
const Footer = () => (
  <footer className="bg-black border-t border-gray-700/50 py-8 text-center text-gray-400">
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div className="flex justify-center space-x-6 mb-4">
        <SocialLink href="https://instagram.com" icon="fab fa-instagram" label="Instagram" />
        <SocialLink href="https://youtube.com" icon="fab fa-youtube" label="YouTube" />
        <SocialLink href="mailto:hello@creator.com" icon="fas fa-envelope" label="Email" />
      </div>
      <p>&copy; {new Date().getFullYear()} Video Creator. All rights reserved.</p>
      <p className="text-sm">Built with React, Tailwind CSS, and Firebase.</p>
    </div>
  </footer>
);

/**
 * Main App Component
 */
export default function App() {
  const [page, setPage] = useState('home');
  const [videos, setVideos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [authReady, setAuthReady] = useState(false);
  const [userId, setUserId] = useState(null);

  // --- Firebase Authentication Effect ---
  useEffect(() => {
    if (!auth) {
      console.error("Firebase Auth is not initialized.");
      setError("Firebase error. Check console.");
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in
        setUserId(user.uid);
        setAuthReady(true);
      } else {
        // User is signed out, try to sign in
        try {
          const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
          if (authToken) {
            await signInWithCustomToken(auth, authToken);
          } else {
            await signInAnonymously(auth);
          }
          // onAuthStateChanged will run again with the new user
        } catch (authError) {
          console.error("Error signing in: ", authError);
          setError("Could not authenticate. Backend features are disabled.");
        }
      }
    });
    
    return () => unsubscribe(); // Cleanup on unmount
  }, []);

  // --- Firestore Data Fetching Effect ---
  useEffect(() => {
    if (!authReady || !db) {
      // Wait for authentication and DB init
      return;
    }

    setLoading(true);
    // Use a public collection for this demo
    const videoCollectionPath = `artifacts/${appId}/public/data/videos`;
    const videoCollection = collection(db, videoCollectionPath);

    const unsubscribe = onSnapshot(videoCollection, (snapshot) => {
      const videoList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setVideos(videoList);
      setLoading(false);
    }, (err) => {
      console.error("Error fetching videos: ", err);
      setError("Could not load videos from database.");
      setLoading(false);
    });

    return () => unsubscribe(); // Cleanup listener on unmount
  }, [authReady]); // Re-run when auth is ready

  // --- Firestore 'Add Video' Handler ---
  const handleAddVideo = useCallback(async (videoData) => {
    if (!db) {
      setError("Database not connected.");
      return;
    }
    setLoading(true);
    setError(null);
    try {
      const videoCollectionPath = `artifacts/${appId}/public/data/videos`;
      await addDoc(collection(db, videoCollectionPath), videoData);
    } catch (err) {
      console.error("Error adding video: ", err);
      setError("Failed to add video.");
    }
    setLoading(false);
  }, [db]); // Include dependencies

  // --- Firestore 'Delete Video' Handler ---
  const handleDeleteVideo = useCallback(async (id) => {
    if (!db) {
      setError("Database not connected.");
      return;
    }
    setError(null);
    try {
      const videoDocPath = `artifacts/${appId}/public/data/videos/${id}`;
      await deleteDoc(doc(db, videoDocPath));
    } catch (err) {
      console.error("Error deleting video: ", err);
      setError("Failed to delete video.");
    }
  }, [db]); // Include dependencies
  
  // --- Render Page Content ---
  const renderPage = () => {
    switch (page) {
      case 'home':
        return (
          <>
            <HeroSection />
            <VideoGallery videos={videos} initialFilter="all" />
            <AboutSection />
            <ContactSection />
          </>
        );
      case 'reels':
        return <VideoGallery videos={videos} initialFilter="reels" />;
      case 'cooking':
        return <VideoGallery videos={videos} initialFilter="cooking" />;
      case 'long':
        return <VideoGallery videos={videos} initialFilter="long" />;
      case 'about':
        return <AboutSection />;
      case 'contact':
        return <ContactSection />;
      case 'admin':
        return (
          <AdminPanel
            videos={videos}
            onAddVideo={handleAddVideo}
            onDeleteVideo={handleDeleteVideo}
            error={error}
            loading={loading}
            userId={userId}
          />
        );
      default:
        return <HeroSection />;
    }
  };

  return (
    <div className="bg-black min-h-screen">
      {/* FontAwesome Script */}
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
      {/* Inter Font */}
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
      
      <style>{`
        body { font-family: 'Inter', sans-serif; }
        /* Simple pulse animation for about me photo */
        @keyframes pulse-slow {
          0%, 100% { transform: scale(1); opacity: 0.5; }
          50% { transform: scale(1.05); opacity: 0.2; }
        }
        .animate-pulse-slow {
          animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
      `}</style>
      
      <Header setPage={setPage} currentPage={page} />
      <main className={page !== 'home' ? 'pt-16' : ''}>
        {renderPage()}
      </main>
      <Footer />
    </div>
  );
}
